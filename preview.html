<!DOCTYPE html>
<html>
<head>
  <title>Flipbook Preview</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #111;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
    }

    #counter {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      color: white;
      border-radius: 4px;
      z-index: 10;
      font-size: 14px;
    }

    #canvas-padding-wrapper {
      width: 100%;
      height: 100%;
      padding: 40px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #canvas-wrapper {
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      image-rendering: pixelated;
      display: block;
      max-width: 100%;
      max-height: 100%;
      height: auto;
      width: auto;
    }
  </style>
</head>
<body>
  <div id="counter">Frame: 0</div>

  <div id="canvas-padding-wrapper">
    <div id="canvas-wrapper">
      <canvas id="previewCanvas"></canvas>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("previewCanvas");
    const ctx = canvas.getContext("2d");
    const counter = document.getElementById("counter");
    const fps = 12;

    let rawFrames = [];        // raw dataURLs
    let loadedImages = [];     // Image() objects
    let totalFramesExpected = null;
    let frameIndex = 0;
    let animationStarted = false;

    // 🔁 Draw loop using requestAnimationFrame
    function animateLoop() {
      const img = loadedImages[frameIndex];
      if (img && img.complete && img.naturalWidth > 0) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        counter.textContent = `Frame: ${frameIndex + 1}`;
      }

      frameIndex = (frameIndex + 1) % loadedImages.length;
      setTimeout(() => requestAnimationFrame(animateLoop), 1000 / fps);
    }

    function startIfReady() {
      if (totalFramesExpected !== null && rawFrames.length === totalFramesExpected) {
        preloadImages();
      }
    }

    function preloadImages() {
      let loadedCount = 0;
      loadedImages = rawFrames.map((src, i) => {
        const img = new Image();
        img.onload = () => {
          loadedCount++;
          if (loadedCount === rawFrames.length && !animationStarted) {
            animationStarted = true;
            canvas.width = img.width;
            canvas.height = img.height;
            requestAnimationFrame(animateLoop);
          }
        };
        img.onerror = () => console.warn("❌ Failed to load frame " + (i + 1));
        img.src = src;
        return img;
      });
    }

    // ✅ Listen for messages from plugin
    window.addEventListener("message", (event) => {
      const { type, data, total } = event.data || {};

      if (type === "frame") {
        rawFrames.push(data);
        startIfReady();
      }

      if (type === "frameCount") {
        totalFramesExpected = total;
        startIfReady();
      }
    });
  </script>
</body>
</html>
