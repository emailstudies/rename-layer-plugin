<!-- preview.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Flipbook Preview</title>
  <style>
    html, body {
      margin: 0;
      background: #111;
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: sans-serif;
    }
    canvas {
      image-rendering: pixelated;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div>ðŸ§  Frames cached in this tab</div>
  <canvas id="previewCanvas"></canvas>

  <script>
    let cachedImages = [];
    const canvas = document.getElementById("previewCanvas");
    const ctx = canvas.getContext("2d");
    const fps = 12;
    let index = 0;

    const startLoop = () => {
      if (!cachedImages.length) return;
      canvas.width = cachedImages[0].width;
      canvas.height = cachedImages[0].height;
      setInterval(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(cachedImages[index], 0, 0);
        index = (index + 1) % cachedImages.length;
      }, 1000 / fps);
    };

    const preloadImages = (srcArray) => {
      let loaded = 0;
      srcArray.forEach((src, i) => {
        const img = new Image();
        img.onload = () => {
          loaded++;
          if (loaded === srcArray.length) startLoop();
        };
        img.src = "data:image/png;base64," + src;
        cachedImages[i] = img;
      });
    };

    window.addEventListener("message", (event) => {
      if (event.data?.type === "images" && Array.isArray(event.data.images)) {
        preloadImages(event.data.images);
        console.log("âœ… Received", event.data.images.length, "frames. Cached in memory.");
      }
    });
  </script>
</body>
</html>
